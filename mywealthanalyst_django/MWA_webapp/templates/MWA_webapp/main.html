{% extends "MWA_webapp/head.html" %}

{% load tz %}
{% load static %}
{% block title %} mywealthanalyst - dashboard {% endblock %}
{% block description %} mywealthanalyst - providing information and analysis on the true value of investment assets to safeguard your wealth for generations. {% endblock %}

{% block head %}
<script src="{% static 'MWA_webapp/MWA_webapp.js' %}?id=2"></script>
<meta http-equiv="Refresh" content="300">

{% endblock %}

{% block content %}



<div>
   <br>
   <br>
<div class='col-md-8 offset-md-2 col-12 dashboard'>

    <div class='row'>
          <div class='col-md-11 col-12' align="left">
                  <table class="table">
                        <thead>
                              <tr>
                                {% for item in Commodities %}
                                <th> {{ item.commodity_name }} </th>
                                {% endfor %}
                              </tr>
                        </thead>
                        <tbody>
                              <tr>
                                {% for item in Commodities %}

                                    {% if item.commodity_name == 'Property' %}
                                    <td class="currency""><span class="currency_togglable" id="propertyprice" data-monetary-amount="{{ Property.SYD|floatformat:0 }}"></span></td>
                                    {% else %}
                                    <td class="currency""><span class="currency_togglable" data-monetary-amount="{{ item.last_price|floatformat:2 }}"></span></td>
                                    {% endif %}

                                {% endfor %}
                              </tr>

                              <tr>
                                {% for item in Commodities %}
                                    {% if item.commodity_name == 'Property' %}
                                       <td></td>
                                    {% else %}
                                       {% if 0 > item.last_movement_nominal %}
                                           <td class="price_small negative">
                                             <span class="currency_togglable" data-monetary-amount="{{ item.last_movement_nominal|floatformat:2 }}"></span>
                                             (<span data-monetary-amount="{{ item.last_movement_percentage|floatformat:2 }}"></span>%)
                                           </td>
                                       {% else %}
                                       <td class="price_small positive">
                                         <span class="currency_togglable" data-monetary-amount="{{ item.last_movement_nominal|floatformat:2 }}"></span>
                                         (<span data-monetary-amount="{{ item.last_movement_percentage|floatformat:2 }}"></span>%)
                                       </td>
                                       {% endif %}
                                    {% endif %}
                                {% endfor %}
                              </tr>

                              <tr>
                                {% for item in Commodities %}
                                  {% if item.commodity_name == "Property" %}
                                  <td class="price_small" style="font-size:9pt"> {% localtime on %}{{Property.name|date:"Y-M-d"}}{% endlocaltime %} </td>
                                  {% else %}
                                  <td class="price_small" style="font-size:9pt"> {{item.date_last_scraped|date:"M-d H:i"}} </td>
                                  {% endif %}
                                {% endfor %}
                              </tr>

                              <tr>
                                {% for item in Commodities %}
                                      {% if item.commodity_name == "Gold"%}
                                    <td class="price_small" style="font-size:9pt"> <a href="https://www.perthmint.com/" target="_blank" style="font-size:9pt">buy now</a> </td>
                                      {% elif item.commodity_name == "Silver"%}
                                    <td class="price_small" style="font-size:9pt"> <a href="https://www.perthmint.com/" target="_blank" style="font-size:9pt">buy now</a> </td>
                                      {% elif item.commodity_name == "All Ords"%}
                                    <td class="price_small" style="font-size:9pt"> <a href="https://www.plus500.com/?id=122624&pl=2" target="_blank" style="font-size:9pt">buy now</a> </td>
                                      {% elif item.commodity_name == "Bitcoin"%}
                                    <td class="price_small" style="font-size:9pt"> <a href="http://coinbase-consumer.sjv.io/QvLVx" target="_blank" style="font-size:9pt">buy now</a> </td>
                                      {% elif item.commodity_name == "Oil"%}
                                    <td class="price_small" style="font-size:9pt"> <a href="https://www.plus500.com/?id=122624&pl=2" target="_blank" style="font-size:9pt">buy now</a> </td>
                                      {% else %}
                                    <td class="price_small" style="font-size:9pt">
                                       <SELECT id="citylist_0" class="chart_dropdown">
                                             <OPTION VALUE="SYD">Sydney</option>
                                             <OPTION VALUE="MEL">Melbourne</option>
                                             <OPTION VALUE="BRI">Brisbane</option>
                                             <OPTION VALUE="ADE">Adelaide</option>
                                             <OPTION VALUE="PER">Perth</option>
                                             <OPTION VALUE="CAN">Canberra</option>
                                             <OPTION VALUE="HOB">Hobart</option>
                                             <OPTION VALUE="DAR">Darwin</option>
                                       </SELECT></td>
                                      {% endif %}
                                {% endfor %}
                              </tr>
                        </tbody>
                  </table>
          </div>
          <div class='col-md-1 col-12 text-center align-self-center' align="center" style="padding:0; padding-right:5px">
              <button type="button" style="width:100%; padding:5px; text-align: center" class="btn btn-primary" id="currency_toggle" value="USD" data-toggle="button" aria-pressed="false" autocomplete="off">USD</button>
          </div>
      </div>




</div>
</div>
</div>

<br>

<div class='col-md-8 offset-md-2 col-12'>

<div class='row graph_row'>
  <SELECT id="citylist_1" class="chart_dropdown">
        <OPTION VALUE="SYD">Sydney</option>
        <OPTION VALUE="MEL">Melbourne</option>
        <OPTION VALUE="BRI">Brisbane</option>
        <OPTION VALUE="ADE">Adelaide</option>
        <OPTION VALUE="PER">Perth</option>
        <OPTION VALUE="CAN">Canberra</option>
        <OPTION VALUE="HOB">Hobart</option>
        <OPTION VALUE="DAR">Darwin</option>
  </SELECT>
      <div id="container_multichart" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <div id="container_gold_silver" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <SELECT id="citylist_2" class="chart_dropdown">
            <OPTION VALUE="SYD">Sydney</option>
            <OPTION VALUE="MEL">Melbourne</option>
            <OPTION VALUE="BRI">Brisbane</option>
            <OPTION VALUE="ADE">Adelaide</option>
            <OPTION VALUE="PER">Perth</option>
            <OPTION VALUE="CAN">Canberra</option>
            <OPTION VALUE="HOB">Hobart</option>
            <OPTION VALUE="DAR">Darwin</option>
      </SELECT>
      <div id="container_houseprice_gold" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <SELECT id="citylist_3" class="chart_dropdown">
            <OPTION VALUE="SYD">Sydney</option>
            <OPTION VALUE="MEL">Melbourne</option>
            <OPTION VALUE="BRI">Brisbane</option>
            <OPTION VALUE="ADE">Adelaide</option>
            <OPTION VALUE="PER">Perth</option>
            <OPTION VALUE="CAN">Canberra</option>
            <OPTION VALUE="HOB">Hobart</option>
            <OPTION VALUE="DAR">Darwin</option>
      </SELECT>
      <div id="container_houseprice_annualincome" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <div id="container_allordsperatio" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <div id="container_allords_gold" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <div id="container_bitcoin_gold" style="height: 400px; width: 100%"></div>
</div>

<div class='row graph_row'>
      <div id="container_bitcoin_allords" style="height: 400px; width: 100%"></div>
</div>

</div>


<script src="{% static 'MWA_webapp/MWA_multichart.js' %}"></script>

<script>

  function numberformatter(string){
    return(parseFloat(toString(string).replace(",","")))
  }

  $('#citylist_0').change(function(){
     var city = $("#citylist_0").val();
     $.getJSON(`/getpropertyprice/?city=${city}`, function (data) {
     if ( $('#currency_toggle').text() == 'USD'){
        $("#propertyprice").attr('data-monetary-amount', parseFloat(data).toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
     }
     if ($('#currency_toggle').text() == 'AUD'){
        $("#propertyprice").attr('data-monetary-amount', parseFloat(data/{{AUD.last_price}}).toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
     }
  })
})

  $('#currency_toggle').on('click', function(event) {
    if (this.innerHTML == 'USD'){
        this.innerHTML = 'AUD';
        $('#currency_toggle').val("AUD")
        $('#currency_toggle').css("background-color", "rgba(255, 153, 0, 1)");

        $(".currency_togglable").each(function() {
            $(this).attr('data-monetary-amount',
                                ((parseFloat(String($(this).attr('data-monetary-amount')).replace(",",""))/{{AUD.last_price}}).toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                        ) ;

        });

    } else {
        this.innerHTML = 'USD';
        $('#currency_toggle').val("USD")
        $('#currency_toggle').css("background-color", "rgb(68, 114, 196)");

        $(".currency_togglable").each(function() {
          $(this).attr('data-monetary-amount',
                                ((parseFloat(String($(this).attr('data-monetary-amount')).replace(",",""))*{{AUD.last_price}}).toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ) ;

        });
    }
  });

  plot_chart('gold','silver', 45,80)
  plot_chart('houseprice','gold', 'std', 'std', "#citylist_2")
  plot_chart('houseprice','annualincome', null, null, "#citylist_3")
  plot_allordsPEratio('allordsperatio',12,16)
  plot_chart('allords','gold', 2.5, 5)
  plot_chart('bitcoin','gold', 2, 5)
  plot_chart('bitcoin','allords')


  $('#citylist_1').change(function(){
    var seriesOptions = [],
      seriesCounter = 0,
      names = [['houseprice','gold'],
               ['allords','gold'],
               ['allordsperatio','identity'],
              ];

    var city = $("#citylist_1").val();

    var rangeselector = {
      selected: 2,
      buttons: [{
                    type: 'month',
                    count: 6,
                    text: '6m'
                }, {
                    type: 'year',
                    count: 1,
                    text: '1y'
                }, {
                    type: 'year',
                    count: 5,
                    text: '5y'
                }, {
                    type: 'year',
                    count: 15,
                    text: '15y'
                }, {
                    type: 'ytd',
                    text: 'YTD'
                }, {
                    type: 'all',
                    text: 'ALL'
                }]
    };

    var plotbandcolour = 'rgba(127,127,27,0.15)';
    var plotbands = [
    {
                color: plotbandcolour, // Color value
                from: 120873600000, // Nov 1973
                to: 162777600000, // Mar 1975
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
              {
                color: plotbandcolour, // Color value
                from: 315446400000, // Jan 1980
                to: 331171200000, //  June 1980
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
              {
                color: plotbandcolour, // Color value
                from: 362707200000, // July 1981
                to: 404870400000, // Nov 1982
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
              {
                color: plotbandcolour, // Color value
                from: 646704000000, // July 1990
                to: 667699200000, // March 1991
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
              {
                color: plotbandcolour, // Color value
                from: 867715200000, // July 1997
                to: 899251200000, // July 1998
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
              {
                color: plotbandcolour, // Color value
                from: 983318400000, // March 2001
                to: 1004486400000, // Nov 2001
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
              {
                color: plotbandcolour, // Color value
                from: 1196380800000, // Dec 2007
                to: 1243728000000, // June 2009
                label: {
                        text:'',
                        rotation: 90,
                        align:'left',
                        style:{"fontSize": "11px"},
                        y: 3,
                        x: 3,
                        color: 'rgb(34,42,53)'       },
              },
            ];

    function createChart() {
      Highcharts.stockChart('container_multichart', {
        rangeSelector: rangeselector,
        credits:{enabled:false},
        exporting:{enabled:false},
        colors: ['#7CB5EC','#FF9900','#FF5050'],
        tooltip: {
            valueDecimals: 2,
            split: true,
        },
        xAxis: {
                  plotBands: plotbands
              },
        plotOptions: {
          series: {
            showInNavigator: true
          }
        },
        series: seriesOptions,
        title: {
            enabled: true,
            text: "Median House Price : Gold : All Ordinaries",
            align: 'left',
            style: {'fontWeight':'bold'},
        },
      });
    }

    $.each(names, function(i, name) {
      $.getJSON(`/getdata/?commodity_one=${name[0]}&commodity_two=${name[1]}&city=${city}`, function (data) {

        seriesOptions[i] = {
          name: `${jsUcfirst(prettifystringnames(name[0]))} : ${jsUcfirst(prettifystringnames(name[1]))}`,
          data: data,
        };

        // As we're loading the data asynchronously, we don't know what order it will arrive. So
        // we keep a counter and create the chart when all the data is loaded.
        seriesCounter += 1;

        if (seriesCounter === names.length) {
          createChart();
        }
      });
    });
  })

  $('#citylist_2').change(function(){
      plot_chart('houseprice','gold', 'std', 'std', "#citylist_2")
  })

  $('#citylist_3').change(function(){
      plot_chart('houseprice','annualincome', null, null, "#citylist_3")
  })

</script>

{% endblock %}
